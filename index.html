<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Luy·ªán g√µ 10 ng√≥n ti·∫øng Vi·ªát ‚Äì VNI (FINAL)</title>

<style>
body{font-family:Arial,sans-serif;background:#f4f4f4;padding:20px}
.container{max-width:1100px;margin:auto;background:#fff;padding:20px;border-radius:8px}
h1{margin-top:0}

textarea,input{width:100%;font-size:18px;padding:8px;margin-top:6px}
button{margin-top:8px;padding:6px 12px;font-size:16px}

/* ===== TEXT DISPLAY (2 LINES ONLY) ===== */
.text-wrapper{
  font-family:Consolas,"Courier New",monospace;
  font-size:24px;
  line-height:1.6;
  margin:16px 0;
  max-height:3.2em; /* 2 lines */
  overflow:hidden;
}
.line{
  white-space:pre;
}
.sample{color:#bbb}
.typed{color:#4caf50}
.cursor{
  display:inline-block;
  width:2px;
  height:1.2em;
  background:#000;
  animation:blink 1s steps(2,start) infinite;
}
@keyframes blink{to{visibility:hidden}}

.keyboard{margin-top:16px}
.row{display:flex;justify-content:center}
.key{width:38px;height:38px;margin:3px;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;border-radius:4px;background:#eee;font-weight:bold}
.key.active{background:#4caf50;color:#fff}

.hands{display:flex;justify-content:space-between;margin-top:16px}
svg{border:1px solid #ddd;border-radius:6px;background:#fafafa}
.finger{fill:#ccc}
.finger.active{fill:#ff9800}

.hint{margin-top:10px;color:#444;font-weight:bold}
.timer{margin-top:10px;font-weight:bold}

#hiddenInput {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  opacity: 0;
  pointer-events: none;
}

/* ===== RESULT BOX ===== */
.result{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding:24px 32px;
  border:3px solid #4caf50;
  border-radius:12px;
  text-align:center;
  background:#f6fff8;
  z-index: 9999;
}

.result-title{
  font-size:22px;
  font-weight:bold;
  color:#2e7d32;
  margin-bottom:8px;
}

.result-wpm{
  display:inline-block;
  padding:8px 16px;
  border:2px dashed #4caf50;
  border-radius:8px;
  font-size:20px;
  font-weight:bold;
  color:#1b5e20;
}

.hidden{
  display:none;
}

</style>
</head>

<body>
<div class="container">
<h1>LUY·ªÜN G√ï VNI 10 NG√ìN TI·∫æNG VI·ªÜT</h1>

<textarea id="sampleInput" rows="2">
h√£y nh·∫≠p ƒëo·∫°n vƒÉn b·∫£n b·∫°n mu·ªën luy·ªán t·∫°i √¥ n√†y
</textarea>

<button id="randomBtn">Random text</button>
<button id="startBtn">B·∫Øt ƒë·∫ßu luy·ªán</button>

<div class="text-wrapper">
  <div class="line" id="line1"></div>
  <div class="line" id="line2"></div>
</div>

<input
  id="hiddenInput"
  autocomplete="off"
  autocorrect="off"
  autocapitalize="off"
/>

<div class="timer" id="timer">Th·ªùi gian: 60s | WPM: 0</div>
<div class="keyboard" id="keyboard"></div>

<div class="hands">
  <svg id="handLeft" width="240" height="160"></svg>
  <svg id="handRight" width="240" height="160"></svg>
</div>

<div class="hint" id="hint"></div>

<div id="resultBox" class="result hidden">
  <div class="result-title">Ch√∫c m·ª´ng!</div>
  <div class="result-wpm">
    WPM = <span id="resultWPM">0</span>
  </div>
  <button id="resetBtn" style="margin-top:16px;font-size:16px;padding:8px 16px">
    Luy·ªán l·∫°i
  </button>
</div>

</div>

<script>
/* ===== VNI STEP MAP ===== */
const specialVowels = {
  '∆∞∆°': ['u','o','7'],
  '∆∞·ªõ': ['u','o','7','1'],
  '∆∞·ªù': ['u','o','7','2'],
  '∆∞·ªü': ['u','o','7','3'],
  '∆∞·ª°': ['u','o','7','4'],
  '∆∞·ª£': ['u','o','7','5']
};

const stepMap={
  'a':['a'],'√°':['a','1'],'√†':['a','2'],'·∫£':['a','3'],'√£':['a','4'],'·∫°':['a','5'],
  '√¢':['a','6'],'·∫•':['a','6','1'],'·∫ß':['a','6','2'],'·∫©':['a','6','3'],'·∫´':['a','6','4'],'·∫≠':['a','6','5'],
  'ƒÉ':['a','8'],'·∫Ø':['a','8','1'],'·∫±':['a','8','2'],'·∫≥':['a','8','3'],'·∫µ':['a','8','4'],'·∫∑':['a','8','5'],
  'e':['e'],'√©':['e','1'],'√®':['e','2'],'·∫ª':['e','3'],'·∫Ω':['e','4'],'·∫π':['e','5'],
  '√™':['e','6'],'·∫ø':['e','6','1'],'·ªÅ':['e','6','2'],'·ªÉ':['e','6','3'],'·ªÖ':['e','6','4'],'·ªá':['e','6','5'],
  'i':['i'],'√≠':['i','1'],'√¨':['i','2'],'·ªâ':['i','3'],'ƒ©':['i','4'],'·ªã':['i','5'],
  'o':['o'],'√≥':['o','1'],'√≤':['o','2'],'·ªè':['o','3'],'√µ':['o','4'],'·ªç':['o','5'],
  '√¥':['o','6'],'·ªë':['o','6','1'],'·ªì':['o','6','2'],'·ªï':['o','6','3'],'·ªó':['o','6','4'],'·ªô':['o','6','5'],
  '∆°':['o','7'],'·ªõ':['o','7','1'],'·ªù':['o','7','2'],'·ªü':['o','7','3'],'·ª°':['o','7','4'],'·ª£':['o','7','5'],
  'u':['u'],'√∫':['u','1'],'√π':['u','2'],'·ªß':['u','3'],'≈©':['u','4'],'·ª•':['u','5'],
  '∆∞':['u','7'],'·ª©':['u','7','1'],'·ª´':['u','7','2'],'·ª≠':['u','7','3'],'·ªØ':['u','7','4'],'·ª±':['u','7','5'],
  'y':['y'],'√Ω':['y','1'],'·ª≥':['y','2'],'·ª∑':['y','3'],'·ªπ':['y','4'],'·ªµ':['y','5'],
  'ƒë':['d','9'],
  ' ':[' ']
};

const composeMap={
  'a1':'√°','a2':'√†','a3':'·∫£','a4':'√£','a5':'·∫°',
  'a6':'√¢','a61':'·∫•','a62':'·∫ß','a63':'·∫©','a64':'·∫´','a65':'·∫≠',
  'a8':'ƒÉ','a81':'·∫Ø','a82':'·∫±','a83':'·∫≥','a84':'·∫µ','a85':'·∫∑',
  'e1':'√©','e2':'√®','e3':'·∫ª','e4':'·∫Ω','e5':'·∫π',
  'e6':'√™','e61':'·∫ø','e62':'·ªÅ','e63':'·ªÉ','e64':'·ªÖ','e65':'·ªá',
  'i1':'√≠','i2':'√¨','i3':'·ªâ','i4':'ƒ©','i5':'·ªã',
  'o1':'√≥','o2':'√≤','o3':'·ªè','o4':'√µ','o5':'·ªç',
  'o6':'√¥','o61':'·ªë','o62':'·ªì','o63':'·ªï','o64':'·ªó','o65':'·ªô',
  'o7':'∆°','o71':'·ªõ','o72':'·ªù','o73':'·ªü','o74':'·ª°','o75':'·ª£',
  'u1':'√∫','u2':'√π','u3':'·ªß','u4':'≈©','u5':'·ª•',
  'u7':'∆∞','u71':'·ª©','u72':'·ª´','u73':'·ª≠','u74':'·ªØ','u75':'·ª±',
  'y1':'√Ω','y2':'·ª≥','y3':'·ª∑','y4':'·ªπ','y5':'·ªµ',
  'd9':'ƒë'
};

/* ===== KEYBOARD + HAND ===== */
const keyboardLayout=[['1','2','3','4','5','6','7','8','9','0'],['q','w','e','r','t','y','u','i','o','p'],['a','s','d','f','g','h','j','k','l',';'],['z','x','c','v','b','n','m',',','.','/']];
const fingerMap={
  q:'l5',a:'l5',z:'l5',
  w:'l4',s:'l4',x:'l4','1':'l5',
  e:'l3',d:'l3',c:'l3','2':'l4',
  r:'l2',f:'l2',v:'l2',t:'l2',g:'l2','3':'l3','4':'l2','5':'l2',
  y:'r2',h:'r2',n:'r2',u:'r2',j:'r2','6':'r2','7':'r2',
  i:'r3',k:'r3',m:'r3','8':'r3',
  o:'r4',l:'r4',',':'r4','9':'r4',
  p:'r5',';':'r5','b':'l4','.':'r5','/':'r5','0':'r5',
  ' ':'l1'
};

const keyboardEl=document.getElementById('keyboard');
function renderKeyboard(active){
  keyboardEl.innerHTML='';
  keyboardLayout.forEach(row=>{
    const r=document.createElement('div');r.className='row';
    row.forEach(k=>{
      const d=document.createElement('div');d.className='key';d.textContent=k;
      if(k===active)d.classList.add('active');
      r.appendChild(d);
    });
    keyboardEl.appendChild(r);
  });
}
function drawHand(svg,active){
  svg.innerHTML='';
  const xs=[20,60,100,140,180];
  const ids=svg.id==='handLeft'?['l5','l4','l3','l2','l1']:['r1','r2','r3','r4','r5'];
  xs.forEach((x,i)=>{
    const r=document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x',x);r.setAttribute('y',40);
    r.setAttribute('width',30);r.setAttribute('height',90);
    r.setAttribute('rx',12);
    r.setAttribute('class','finger'+(active===ids[i]?' active':''));
    svg.appendChild(r);
  });
}
function guideKey(k){
  renderKeyboard(k);
  const f=fingerMap[k];
  drawHand(handLeft,f&&f.startsWith('l')?f:null);
  drawHand(handRight,f&&f.startsWith('r')?f:null);
  hint.textContent=`G√µ ph√≠m: ${k===' '?'SPACE':k}`;
}

/* ===== TRAINING CORE ===== */
/* ===== RANDOM TEXT SOURCE ===== */
const randomTexts = [
  'hai con th·∫±n l·∫±n con v·ªãt ƒëang b∆°i d∆∞·ªõi ao l√†ng y√™n ·∫£',
  'ng∆∞·ªùi th·ª£ r√®n g√µ b√∫a ƒë·ªÅu tay gi·ªØa bu·ªïi tr∆∞a n·∫Øng g·∫Øt',
  'tr·ªùi m∆∞a nh·∫π l√†m con ƒë∆∞·ªùng ƒë·∫•t tr·ªü n√™n tr∆°n tr∆∞·ª£t',
  'ƒë√†n chim s·∫ª bay ngang qua m√°i nh√† l√∫c chi·ªÅu xu·ªëng',
  'b√† c·ª• ng·ªìi b√™n hi√™n k·ªÉ chuy·ªán ng√†y x∆∞a cho ch√°u nghe',
  'd√≤ng s√¥ng u·ªën l∆∞·ª£n quanh l√†ng mang theo ph√π sa ƒë·ªè',
  'ti·∫øng g√† g√°y vang xa b√°o hi·ªáu m·ªôt ng√†y m·ªõi b·∫Øt ƒë·∫ßu',
  'ng·ªçn ƒë√®n d·∫ßu leo l√©t soi s√°ng cƒÉn ph√≤ng nh·ªè y√™n tƒ©nh',
  'c∆°n gi√≥ nh·∫π th·ªïi qua h√†ng tre ph√°t ra √¢m thanh x√†o x·∫°c',
  'chi·∫øc thuy·ªÅn nh·ªè tr√¥i ch·∫≠m tr√™n m·∫∑t n∆∞·ªõc ph·∫≥ng l·∫∑ng'
];

function generateRandomText(targetLength = 300){
  let result = '';
  while(result.length < targetLength){
    const sentence =
      randomTexts[Math.floor(Math.random() * randomTexts.length)];
    result += sentence + ' ';
  }
  return result.trim().slice(0, targetLength);
}

let steps=[],idx=0,out='',time=60,timer=null;

// ===== DISPLAY COUNTERS (QUAN TR·ªåNG) =====
let committedChars = 0;     // s·ªë k√Ω t·ª± g·ªëc ƒë√£ ho√†n th√†nh
let charSteps = [];         // s·ªë ph√≠m cho t·ª´ng k√Ω t·ª± g·ªëc
let currentCharIdx = 0;     // ƒëang g√µ k√Ω t·ª± g·ªëc th·ª© m·∫•y
let currentCharStep = 0;    // ƒë√£ g√µ bao nhi√™u ph√≠m c·ªßa k√Ω t·ª± ƒë√≥  


const hiddenInput=document.getElementById('hiddenInput');
const timerEl=document.getElementById('timer');
const hint=document.getElementById('hint');
const line1=document.getElementById('line1');
const line2=document.getElementById('line2');
const resultBox = document.getElementById('resultBox');
const resultWPM = document.getElementById('resultWPM');


// ===== FIX START: toSteps with cluster =====
function toSteps(txt){
  const text = txt.toLowerCase();
  const steps = [];
  let i = 0;

  while (i < text.length) {

    // ===== ∆ØU TI√äN C·ª§M ƒê·∫∂C BI·ªÜT (∆∞∆°, ∆∞·ªõ, ...) =====
    let matched = false;
    for (const cluster in specialVowels) {
      if (text.startsWith(cluster, i)) {
        steps.push(...specialVowels[cluster]);
        i += cluster.length;
        matched = true;
        break;
      }
    }
    if (matched) continue;

    // ===== K√ù T·ª∞ ƒê∆†N =====
    const ch = text[i];
    if (stepMap[ch]) {
      steps.push(...stepMap[ch]);
    } else {
      steps.push(ch);
    }
    i++;
  }

  return steps;
}

// ===== FIX END =====


// ===== MAP S·ªê PH√çM CHO M·ªñI K√ù T·ª∞ G·ªêC =====
function stepsForChar(ch){
  return stepMap[ch] ? stepMap[ch].length : 1;
}

// ===== FIX START: charSteps sync =====
function prepareCharSteps(text){
  charSteps = [];
  const txt = text.toLowerCase();
  let i = 0;

  while (i < txt.length) {

    let matched = false;
    for (const cluster in specialVowels) {
      if (txt.startsWith(cluster, i)) {
        charSteps.push({
          steps: specialVowels[cluster].length, // s·ªë ph√≠m c·∫ßn g√µ
          chars: cluster.length                 // s·ªë k√Ω t·ª± g·ªëc
        });
        i += cluster.length;
        matched = true;
        break;
      }
    }
    if (matched) continue;

    const ch = txt[i];
    charSteps.push({
      steps: stepMap[ch]?.length || 1,
      chars: 1
    });
    i++;
  }
}


// ===== FIX END =====

function renderLines(){
  const src = [...document.getElementById('sampleInput').value];
  const typed = [...out];
 const cur = committedChars;

  const LINE_LEN = 40;
  const start = Math.floor(cur / LINE_LEN) * LINE_LEN;

  let html = '';

  for(let i = start; i < start + LINE_LEN; i++){
    if(i < cur){
      html += `<span class="typed">${src[i] || ''}</span>`;
    }
    else if(i === cur){

      html += `<span class="cursor"></span><span class="sample">${src[i] || ''}</span>`;
    }
    else{
      html += `<span class="sample">${src[i] || ''}</span>`;
    }
  }

  line1.innerHTML = html;
  line2.textContent = '';
}


function start(){
  const text = document.getElementById('sampleInput').value.trim();

  steps = toSteps(text);
  prepareCharSteps(text);

  idx = 0;
  out = '';
  time = 60;

  committedChars = 0;
  currentCharIdx = 0;
  currentCharStep = 0;
  
  clearInterval(timer);
  
  timer=setInterval(()=>{
    time--;
    const elapsed = 60 - time;
const keystrokes = idx;   // idx = s·ªë ph√≠m ƒë√£ g√µ (ƒë√∫ng v·ªõi VNI)
const grossWPM = elapsed > 0
  ? Math.round((keystrokes / 5) * (60 / elapsed))
  : 0;
const textWPM = Math.floor(committedChars / 5);

timerEl.textContent =
  `Th·ªùi gian: ${time}s |`;

if(time <= 0){
  clearInterval(timer);

  const finalWPM = Math.floor(committedChars / 5);
  resultWPM.textContent = finalWPM;

  // ·∫®n giao di·ªán luy·ªán
  document.querySelector('.text-wrapper').style.display = 'none';
  document.getElementById('keyboard').style.display = 'none';
  document.querySelector('.hands').style.display = 'none';
  document.getElementById('timer').style.display = 'none';
  document.getElementById('hint').style.display = 'none';

  // Hi·ªán k·∫øt qu·∫£ gi·ªØa m√†n h√¨nh
  resultBox.classList.remove('hidden');
}


  },1000);
  renderLines();
  hiddenInput.focus();
  guideKey(steps[0]);
}

hiddenInput.addEventListener('keydown',e=>{if(e.key==='Backspace')e.preventDefault();});

let baseVowel='',toneBuffer='';

function gotoNextStep(){
  currentCharStep++;

  const info = charSteps[currentCharIdx];

  if (currentCharStep >= info.steps) {
    committedChars += info.chars; // üî• CH·ªêT: kh√¥ng c√≤n l·ªách nh·ªãp
    currentCharIdx++;
    currentCharStep = 0;
  }

  idx++;
  renderLines();
  guideKey(steps[idx]);
}


hiddenInput.addEventListener('keyup', e => {
  const need = steps[idx];
  if (!need) return;

  const k = e.key === ' ' ? ' ' : e.key.toLowerCase();
  if (k !== need) return;
  
else if (k === '7') {

  // ∆Ø∆†
  if (out.endsWith('uo')) {
    out = out.slice(0, -2) + '∆∞∆°';
    // QUAN TR·ªåNG: return ƒë·ªÉ 7 KH√îNG t·∫°o '∆∞'
    gotoNextStep();
    return;
  }

  // ∆Ø
  if (out.endsWith('u')) {
    out = out.slice(0, -1) + '∆∞';
    gotoNextStep();
    return;
  }

  // ∆†
  if (out.endsWith('o')) {
    out = out.slice(0, -1) + '∆°';
    gotoNextStep();
    return;
  }

  gotoNextStep();
  return;
}

else if (/[1-9]/.test(k)) {
  const last = out.slice(-1);
  const key = last + k;
  if (composeMap[key]) {
    out = out.slice(0, -1) + composeMap[key];
  } else {
    out += k;
  }
  gotoNextStep();
  return;
}

else {
  out += k;
  gotoNextStep();
  return;
}

});

document.getElementById('randomBtn').onclick = () => {
  const ta = document.getElementById('sampleInput');
  ta.value = generateRandomText(300);

  // RESET STATE
  steps = [];
  idx = 0;
  out = '';
  committedChars = 0;
  baseVowel = '';
  toneBuffer = '';
  renderLines();
};

document.getElementById('startBtn').onclick=start;
document.querySelector('.container').addEventListener('click', e => {
  if (e.target.id !== 'sampleInput') {
    hiddenInput.focus();
  }
});

  // r·∫•t nhi·ªÅu code ·ªü tr√™n
  // x·ª≠ l√Ω keyup
  // x·ª≠ l√Ω timer
  // x·ª≠ l√Ω resultBox

 document.getElementById('resetBtn').onclick = () => {
  resultBox.classList.add('hidden');
  start();
};

</script>
</body>
</html>
